name: Build Cilium Images for Multiple Architectures

on:
  workflow_dispatch:
    inputs:
      cilium_version:
        description: 'Cilium version (e.g., v1.16.5)'
        required: false
        default: 'latest'
  schedule:
    # Run monthly on the 10th at midnight
    - cron: "0 0 10 * *"
  push:
    branches:
      - main
    paths:
      - '.github/workflows/build-cilium-images.yml'

env:
  REGISTRY: docker.io
  DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  # Get latest Cilium version
  get-versions:
    runs-on: ubuntu-latest
    outputs:
      cilium_version: ${{ steps.versions.outputs.cilium_version }}
      cilium_tag: ${{ steps.versions.outputs.cilium_tag }}
    steps:
      - name: Get latest Cilium version
        id: versions
        run: |
          if [ "${{ github.event.inputs.cilium_version }}" = "latest" ] || [ -z "${{ github.event.inputs.cilium_version }}" ]; then
            CILIUM_VERSION=$(curl -s https://api.github.com/repos/cilium/cilium/releases/latest | jq -r '.tag_name')
          else
            CILIUM_VERSION="${{ github.event.inputs.cilium_version }}"
          fi
          
          # Remove 'v' prefix for tag
          CILIUM_TAG="${CILIUM_VERSION#v}"
          
          echo "cilium_version=$CILIUM_VERSION" >> "$GITHUB_OUTPUT"
          echo "cilium_tag=$CILIUM_TAG" >> "$GITHUB_OUTPUT"
          
          echo "Building Cilium version: $CILIUM_VERSION (tag: $CILIUM_TAG)"

  # Build Cilium images for x86_64
  build-cilium-x86:
    needs: get-versions
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        component:
          - cilium
          - operator
          - hubble-relay
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Clone Cilium repository
        run: |
          git clone --depth=1 --branch ${{ needs.get-versions.outputs.cilium_version }} https://github.com/cilium/cilium.git
          cd cilium

      - name: Build and push ${{ matrix.component }} for x86_64
        run: |
          cd cilium
          
          case "${{ matrix.component }}" in
            cilium)
              DOCKERFILE="images/cilium/Dockerfile"
              IMAGE_NAME="${{ env.DOCKERHUB_REPO }}/cilium"
              docker buildx build \
                --platform linux/amd64 \
                --build-arg OPERATOR_VARIANT=generic \
                --file ${DOCKERFILE} \
                --tag ${IMAGE_NAME}:${{ needs.get-versions.outputs.cilium_tag }}-amd64 \
                --tag ${IMAGE_NAME}:latest-amd64 \
                --push \
                .
              ;;
            operator)
              DOCKERFILE="images/operator/Dockerfile"
              IMAGE_NAME="${{ env.DOCKERHUB_REPO }}/operator"
              docker buildx build \
                --platform linux/amd64 \
                --build-arg OPERATOR_VARIANT=generic \
                --file ${DOCKERFILE} \
                --tag ${IMAGE_NAME}:${{ needs.get-versions.outputs.cilium_tag }}-amd64 \
                --tag ${IMAGE_NAME}:latest-amd64 \
                --push \
                .
              ;;
            hubble-relay)
              DOCKERFILE="images/hubble-relay/Dockerfile"
              IMAGE_NAME="${{ env.DOCKERHUB_REPO }}/hubble-relay"
              docker buildx build \
                --platform linux/amd64 \
                --build-arg OPERATOR_VARIANT=generic \
                --file ${DOCKERFILE} \
                --tag ${IMAGE_NAME}:${{ needs.get-versions.outputs.cilium_tag }}-amd64 \
                --tag ${IMAGE_NAME}:latest-amd64 \
                --push \
                .
              ;;
          esac

      - name: Build result
        run: echo "âœ… Built ${{ matrix.component }} for x86_64"

  # Build Cilium images for RISC-V
  build-cilium-riscv:
    needs: get-versions
    runs-on: RISCV64
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        component:
          - cilium
          - operator
          - hubble-relay
    steps:
      - name: Check Docker installation
        run: |
          if ! command -v docker &> /dev/null; then
            echo "Docker not found, installing..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
          fi
          
          # Start Docker if not running
          sudo systemctl start docker || true
          sudo systemctl enable docker || true
          
          # Verify Docker is running
          sudo docker ps

      - name: Install Docker buildx
        run: |
          # Create plugin directory
          mkdir -p ~/.docker/cli-plugins/
          
          # Download and install buildx for RISC-V
          BUILDX_VERSION=$(curl -s https://api.github.com/repos/docker/buildx/releases/latest | jq -r '.tag_name')
          
          # Try to download riscv64 binary, fall back to building from source if not available
          if wget -q "https://github.com/docker/buildx/releases/download/${BUILDX_VERSION}/buildx-${BUILDX_VERSION}.linux-riscv64" -O ~/.docker/cli-plugins/docker-buildx; then
            chmod +x ~/.docker/cli-plugins/docker-buildx
          else
            echo "No pre-built buildx for RISC-V, building from source..."
            # Install Go if not present
            if ! command -v go &> /dev/null; then
              GO_VERSION=$(curl -s https://go.dev/VERSION?m=text | head -n1)
              wget -q https://go.dev/dl/${GO_VERSION}.linux-riscv64.tar.gz
              sudo rm -rf /usr/local/go
              sudo tar -C /usr/local -xzf ${GO_VERSION}.linux-riscv64.tar.gz
              export PATH=/usr/local/go/bin:$PATH
            fi
            
            # Build buildx
            git clone --depth=1 --branch ${BUILDX_VERSION} https://github.com/docker/buildx.git
            cd buildx
            make build
            sudo cp bin/buildx ~/.docker/cli-plugins/docker-buildx
            sudo chmod +x ~/.docker/cli-plugins/docker-buildx
            cd ..
            rm -rf buildx
          fi

      - name: Set up Docker Buildx
        run: |
          # Use sudo for docker commands
          sudo docker buildx create --use --name riscv-builder || sudo docker buildx use riscv-builder
          sudo docker buildx inspect --bootstrap

      - name: Log in to DockerHub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | sudo docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Clone Cilium repository
        run: |
          git clone --depth=1 --branch ${{ needs.get-versions.outputs.cilium_version }} https://github.com/cilium/cilium.git
          cd cilium

      - name: Build and push ${{ matrix.component }} for RISC-V
        run: |
          cd cilium
          
          case "${{ matrix.component }}" in
            cilium)
              DOCKERFILE="images/cilium/Dockerfile"
              IMAGE_NAME="${{ env.DOCKERHUB_REPO }}/cilium"
              sudo docker buildx build \
                --platform linux/riscv64 \
                --file ${DOCKERFILE} \
                --tag ${IMAGE_NAME}:${{ needs.get-versions.outputs.cilium_tag }}-riscv64 \
                --tag ${IMAGE_NAME}:latest-riscv64 \
                --push \
                .
              ;;
            operator)
              DOCKERFILE="images/operator-generic/Dockerfile"
              IMAGE_NAME="${{ env.DOCKERHUB_REPO }}/operator-generic"
              sudo docker buildx build \
                --platform linux/riscv64 \
                --file ${DOCKERFILE} \
                --tag ${IMAGE_NAME}:${{ needs.get-versions.outputs.cilium_tag }}-riscv64 \
                --tag ${IMAGE_NAME}:latest-riscv64 \
                --push \
                .
              ;;
            hubble-relay)
              DOCKERFILE="images/hubble-relay/Dockerfile"
              IMAGE_NAME="${{ env.DOCKERHUB_REPO }}/hubble-relay"
              sudo docker buildx build \
                --platform linux/riscv64 \
                --file ${DOCKERFILE} \
                --tag ${IMAGE_NAME}:${{ needs.get-versions.outputs.cilium_tag }}-riscv64 \
                --tag ${IMAGE_NAME}:latest-riscv64 \
                --push \
                .
              ;;
          esac

      - name: Build result
        run: echo "âœ… Built ${{ matrix.component }} for RISC-V"

  # Create multi-arch manifests
  create-manifests:
    needs: [get-versions, build-cilium-x86, build-cilium-riscv]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        component:
          - cilium
          - operator-generic
          - hubble-relay
    steps:
      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create and push multi-arch manifest for ${{ matrix.component }}
        run: |
          IMAGE_NAME="${{ env.DOCKERHUB_REPO }}/${{ matrix.component }}"
          VERSION="${{ needs.get-versions.outputs.cilium_tag }}"
          
          # Create manifest for versioned tag
          docker manifest create ${IMAGE_NAME}:${VERSION} \
            ${IMAGE_NAME}:${VERSION}-amd64 \
            ${IMAGE_NAME}:${VERSION}-riscv64
          
          docker manifest push ${IMAGE_NAME}:${VERSION}
          
          # Create manifest for latest tag
          docker manifest create ${IMAGE_NAME}:latest \
            ${IMAGE_NAME}:latest-amd64 \
            ${IMAGE_NAME}:latest-riscv64
          
          docker manifest push ${IMAGE_NAME}:latest
          
          echo "âœ… Created multi-arch manifest for ${{ matrix.component }}"

  # Generate Cilium installation manifests
  generate-manifests:
    needs: [get-versions, create-manifests]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Cilium CLI
        run: |
          CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
          curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-amd64.tar.gz{,.sha256sum}
          sha256sum --check cilium-linux-amd64.tar.gz.sha256sum
          sudo tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin
          rm cilium-linux-amd64.tar.gz{,.sha256sum}

      - name: Generate Cilium installation manifest
        run: |
          mkdir -p cilium-manifests
          
          # Generate manifest with custom images
          cat > cilium-manifests/cilium-values.yaml << EOF
          image:
            repository: ${{ env.DOCKERHUB_REPO }}/cilium
            tag: ${{ needs.get-versions.outputs.cilium_tag }}
            useDigest: false
          
          operator:
            image:
              repository: ${{ env.DOCKERHUB_REPO }}/operator-generic
              tag: ${{ needs.get-versions.outputs.cilium_tag }}
              useDigest: false
            replicas: 1
          
          hubble:
            enabled: true
            relay:
              enabled: true
              image:
                repository: ${{ env.DOCKERHUB_REPO }}/hubble-relay
                tag: ${{ needs.get-versions.outputs.cilium_tag }}
                useDigest: false
            ui:
              enabled: false
          
          # Kubernetes API server configuration
          k8sServiceHost: REPLACE_WITH_YOUR_API_SERVER_IP
          k8sServicePort: 6443
          
          # Replace kube-proxy
          kubeProxyReplacement: true
          
          # IPAM configuration
          ipam:
            mode: kubernetes
          
          # Tunnel configuration
          tunnelProtocol: vxlan
          
          # Enable native routing mode
          autoDirectNodeRoutes: false
          
          # IPv4 configuration
          ipv4:
            enabled: true
          
          ipv6:
            enabled: false
          
          # Enable endpoint health checking
          enableEndpointHealthChecking: true
          
          # Bandwidth manager
          bandwidthManager:
            enabled: false
          
          # Host firewall
          hostFirewall:
            enabled: false
          
          # Cilium health checks
          healthChecking: true
          
          # Monitoring
          prometheus:
            enabled: true
            serviceMonitor:
              enabled: false
          
          # BGP control plane
          bgpControlPlane:
            enabled: false
          EOF
          
          # Create installation README
          cat > cilium-manifests/README.md << 'EOFREADME'
          # Cilium Installation for RISC-V and x86 Kubernetes

          ## Images Built

          All images are available for both `amd64` and `riscv64` architectures:

          - `${{ env.DOCKERHUB_REPO }}/cilium:${{ needs.get-versions.outputs.cilium_tag }}`
          - `${{ env.DOCKERHUB_REPO }}/operator-generic:${{ needs.get-versions.outputs.cilium_tag }}`
          - `${{ env.DOCKERHUB_REPO }}/hubble-relay:${{ needs.get-versions.outputs.cilium_tag }}`

          ## Quick Installation

          ### Step 1: Update the values file

          Edit `cilium-values.yaml` and replace:
          - `REPLACE_WITH_YOUR_API_SERVER_IP` with your control plane IP address

          ### Step 2: Install Cilium using Helm

          ```bash
          # Add Cilium Helm repository
          helm repo add cilium https://helm.cilium.io/
          helm repo update

          # Install Cilium with custom images
          helm install cilium cilium/cilium \
            --version ${{ needs.get-versions.outputs.cilium_tag }} \
            --namespace kube-system \
            --values cilium-values.yaml
          ```

          ### Step 3: Verify Installation

          ```bash
          # Check Cilium pods
          kubectl get pods -n kube-system -l k8s-app=cilium

          # Check nodes are ready
          kubectl get nodes
          ```

          ## Troubleshooting

          ### Check Cilium agent logs
          ```bash
          kubectl logs -n kube-system -l k8s-app=cilium --tail=50
          ```

          ### Check Cilium operator logs
          ```bash
          kubectl logs -n kube-system -l name=cilium-operator --tail=50
          ```
          EOFREADME

      - name: Upload Cilium manifests as artifact
        uses: actions/upload-artifact@v4
        with:
          name: cilium-manifests-${{ needs.get-versions.outputs.cilium_tag }}
          path: cilium-manifests/

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: cilium-${{ needs.get-versions.outputs.cilium_version }}
          name: Cilium ${{ needs.get-versions.outputs.cilium_version }} for RISC-V and x86
          body: |
            # Cilium ${{ needs.get-versions.outputs.cilium_version }} - Multi-Architecture Images
            
            Container images for Cilium built for both x86_64 and RISC-V architectures.
            
            ## ðŸ Images Available
            
            All images support both `linux/amd64` and `linux/riscv64`:
            
            - `${{ env.DOCKERHUB_REPO }}/cilium:${{ needs.get-versions.outputs.cilium_tag }}`
            - `${{ env.DOCKERHUB_REPO }}/operator-generic:${{ needs.get-versions.outputs.cilium_tag }}`
            - `${{ env.DOCKERHUB_REPO }}/hubble-relay:${{ needs.get-versions.outputs.cilium_tag }}`
            
            ## ðŸš€ Quick Start
            
            ### Install using Helm
            
            ```bash
            # Download the values file from this release
            wget https://github.com/${{ github.repository }}/releases/download/cilium-${{ needs.get-versions.outputs.cilium_version }}/cilium-values.yaml
            
            # Edit cilium-values.yaml and set your API server IP
            # Then install:
            helm repo add cilium https://helm.cilium.io/
            helm install cilium cilium/cilium \
              --version ${{ needs.get-versions.outputs.cilium_tag }} \
              --namespace kube-system \
              --values cilium-values.yaml
            ```
            
            ### Verify Installation
            
            ```bash
            kubectl get pods -n kube-system -l k8s-app=cilium
            kubectl get nodes
            ```
            
            ## ðŸ“¦ What's Included
            
            - Multi-architecture container images (amd64 + riscv64)
            - Helm values file for easy installation
            - Installation documentation
            
            ## ðŸ—ï¸ Architecture Support
            
            - **x86_64**: linux/amd64
            - **RISC-V**: linux/riscv64
            
            ## ðŸ“– Documentation
            
            See the attached `README.md` for detailed installation instructions and troubleshooting.
            
            ## ðŸ”— Links
            
            - [Cilium Documentation](https://docs.cilium.io/)
            - [Cilium GitHub](https://github.com/cilium/cilium)
          files: |
            cilium-manifests/*
          draft: false
          prerelease: false

  # Summary job
  build-summary:
    needs: [get-versions, generate-manifests]
    runs-on: ubuntu-latest
    steps:
      - name: Display build summary
        run: |
          echo "=========================================="
          echo "Cilium Build Complete!"
          echo "=========================================="
          echo ""
          echo "Version: ${{ needs.get-versions.outputs.cilium_version }}"
          echo ""
          echo "Images published to DockerHub:"
          echo "  - ${{ env.DOCKERHUB_REPO }}/cilium:${{ needs.get-versions.outputs.cilium_tag }}"
          echo "  - ${{ env.DOCKERHUB_REPO }}/operator-generic:${{ needs.get-versions.outputs.cilium_tag }}"
          echo "  - ${{ env.DOCKERHUB_REPO }}/hubble-relay:${{ needs.get-versions.outputs.cilium_tag }}"
          echo ""
          echo "Architectures: linux/amd64, linux/riscv64"
          echo ""
          echo "Installation manifests available in release:"
          echo "  https://github.com/${{ github.repository }}/releases/tag/cilium-${{ needs.get-versions.outputs.cilium_version }}"
          echo ""