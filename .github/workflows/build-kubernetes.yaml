name: Build Kubernetes for RISC-V

on:
  workflow_dispatch:
  schedule:
    # Run monthly on the 1st at midnight
    - cron: "0 0 1 * *"
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  build:
    runs-on: RISCV64
    permissions:
      contents: write
    outputs:
      k8s_version: ${{ steps.get-version.outputs.k8s_version }}
      release_tag: ${{ steps.get-version.outputs.release_tag }}

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            rsync \
            jq \
            curl \
            wget

      - name: Setup Go
        run: |
          # Install latest stable Go (required for Kubernetes)
          GO_VERSION=$(curl -s https://go.dev/VERSION?m=text | head -n1)
          wget -q https://go.dev/dl/${GO_VERSION}.linux-riscv64.tar.gz
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf ${GO_VERSION}.linux-riscv64.tar.gz
          rm ${GO_VERSION}.linux-riscv64.tar.gz
          
          # Setup Go environment
          echo "export PATH=/usr/local/go/bin:\$PATH" >> $HOME/.bashrc
          echo "export GOPATH=$HOME/go" >> $HOME/.bashrc
          echo "export PATH=\$PATH:\$GOPATH/bin" >> $HOME/.bashrc
          
          # Verify installation
          /usr/local/go/bin/go version

      - name: Clone Kubernetes and checkout latest stable tag
        id: get-latest-tag
        run: |
          set -eux
          
          # Configure git for better performance
          git config --global http.postBuffer 524288000
          git config --global http.maxRequests 2
          git config --global core.compression 0
          
          # Clone Kubernetes repo (shallow clone)
          rm -rf kubernetes
          git clone --depth=1 --no-tags https://github.com/kubernetes/kubernetes.git
          cd kubernetes
          
          # Fetch latest stable release tag
          git fetch --tags --depth=1
          LATEST_TAG=$(git tag -l "v1.*" | grep -v -E 'alpha|beta|rc' | sort -V | tail -n 1)
          
          echo "Latest stable Kubernetes version: $LATEST_TAG"
          
          # Fetch and checkout the tag
          git fetch --depth=1 origin tag $LATEST_TAG
          git checkout FETCH_HEAD
          
          echo "tag_name=$LATEST_TAG" >> "$GITHUB_OUTPUT"

      - name: Setup build environment
        run: |
          cd kubernetes
          export PATH=/usr/local/go/bin:$PATH
          export GOPATH=$HOME/go
          
          # Verify Go installation
          go version
          
          # Get dependencies
          go mod download

      - name: Build Kubernetes binaries for RISC-V
        run: |
          cd kubernetes
          export PATH=/usr/local/go/bin:$PATH
          export GOPATH=$HOME/go
          
          # Build all main binaries for RISC-V
          # Using make with KUBE_BUILD_PLATFORMS
          echo "Building Kubernetes for linux/riscv64..."
          
          # Option 1: Build all binaries (takes longer but comprehensive)
          KUBE_BUILD_PLATFORMS=linux/riscv64 make all WHAT="cmd/kube-apiserver cmd/kube-controller-manager cmd/kube-scheduler cmd/kubelet cmd/kube-proxy cmd/kubectl cmd/kubeadm"
          
          # The binaries will be in _output/local/go/bin/
          echo "Build completed!"
          ls -lh _output/local/go/bin/ || ls -lh _output/bin/ || find _output -name "kube*" -type f

      - name: Get version and prepare artifacts
        id: get-version
        run: |
          cd kubernetes
          K8S_VERSION=$(cat version 2>/dev/null || git describe --tags --abbrev=0 2>/dev/null || echo "unknown")
          RELEASE_TAG="${{ steps.get-latest-tag.outputs.tag_name }}"
          
          echo "k8s_version=$K8S_VERSION" >> $GITHUB_OUTPUT
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          
          echo "Kubernetes Version: $K8S_VERSION"
          echo "Release Tag: $RELEASE_TAG"

      - name: Package binaries
        run: |
          cd kubernetes
          
          # Find the output directory (Kubernetes build system may vary)
          if [ -d "_output/local/bin/linux_riscv64" ]; then
            BIN_DIR="_output/local/bin/linux_riscv64"
          elif [ -d "_output/bin" ]; then
            BIN_DIR="_output/bin"
          else
            echo "ERROR: Could not find binary output directory"
            find _output -name "kubectl" -type f
            exit 1
          fi
          
          echo "Using binary directory: $BIN_DIR"
          
          # Create packaging directory
          mkdir -p $GITHUB_WORKSPACE/k8s-riscv64-binaries
          
          # Copy binaries
          cp -v $BIN_DIR/kube-apiserver $GITHUB_WORKSPACE/k8s-riscv64-binaries/ || true
          cp -v $BIN_DIR/kube-controller-manager $GITHUB_WORKSPACE/k8s-riscv64-binaries/ || true
          cp -v $BIN_DIR/kube-scheduler $GITHUB_WORKSPACE/k8s-riscv64-binaries/ || true
          cp -v $BIN_DIR/kubelet $GITHUB_WORKSPACE/k8s-riscv64-binaries/ || true
          cp -v $BIN_DIR/kube-proxy $GITHUB_WORKSPACE/k8s-riscv64-binaries/ || true
          cp -v $BIN_DIR/kubectl $GITHUB_WORKSPACE/k8s-riscv64-binaries/ || true
          cp -v $BIN_DIR/kubeadm $GITHUB_WORKSPACE/k8s-riscv64-binaries/ || true
          
          # Verify binaries
          echo "Packaged binaries:"
          ls -lh $GITHUB_WORKSPACE/k8s-riscv64-binaries/
          
          # Create tarball
          RELEASE_TAG="${{ steps.get-latest-tag.outputs.tag_name }}"
          tar -czf $GITHUB_WORKSPACE/kubernetes-${RELEASE_TAG}-riscv64-linux.tar.gz \
            -C $GITHUB_WORKSPACE/k8s-riscv64-binaries .
          
          echo "Archive created:"
          ls -lh $GITHUB_WORKSPACE/kubernetes-${RELEASE_TAG}-riscv64-linux.tar.gz

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kubernetes-${{ steps.get-latest-tag.outputs.tag_name }}-riscv64-linux
          path: ${{ github.workspace }}/kubernetes-${{ steps.get-latest-tag.outputs.tag_name }}-riscv64-linux.tar.gz

      - name: Create or update tag
        run: |
          TAG="${{ steps.get-latest-tag.outputs.tag_name }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git ls-remote --exit-code --tags origin "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "âœ… Tag $TAG already exists. Will update release."
          else
            echo "ðŸ†• Tag $TAG does not exist. Creating and pushing..."
            git tag "$TAG" -m "Kubernetes $TAG build for RISC-V"
            git push origin "$TAG"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get-latest-tag.outputs.tag_name }}
          name: Kubernetes ${{ steps.get-latest-tag.outputs.tag_name }} for RISC-V
          body: |
            # Kubernetes ${{ steps.get-latest-tag.outputs.tag_name }} - RISC-V Build
            
            **Unofficial** RISC-V build of Kubernetes ${{ steps.get-latest-tag.outputs.tag_name }}
            
            ## Included Binaries
            
            - `kube-apiserver` - The Kubernetes API server
            - `kube-controller-manager` - The controller manager
            - `kube-scheduler` - The scheduler
            - `kubelet` - The node agent
            - `kube-proxy` - The network proxy
            - `kubectl` - The command-line tool
            - `kubeadm` - The cluster bootstrapping tool
            
            ## Installation
            
            ```bash
            # Download and extract
            wget https://github.com/${{ github.repository }}/releases/download/${{ steps.get-latest-tag.outputs.tag_name }}/kubernetes-${{ steps.get-latest-tag.outputs.tag_name }}-riscv64-linux.tar.gz
            tar -xzf kubernetes-${{ steps.get-latest-tag.outputs.tag_name }}-riscv64-linux.tar.gz
            
            # Move binaries to PATH
            sudo mv kube* /usr/local/bin/
            
            # Verify installation
            kubectl version --client
            ```
            
            ## Architecture
            - **Platform**: linux/riscv64
            - **Built on**: Milk-V Pioneer (RISC-V)
            - **Go Version**: $(go version | awk '{print $3}')
            
            ## Notes
            - This is an **unofficial community build**
            - Built from official Kubernetes source: https://github.com/kubernetes/kubernetes
            - No modifications to source code
            - For production use, wait for official RISC-V support
            
            ## Related Links
            - [Official Kubernetes Docs](https://kubernetes.io/docs/)
            - [RISC-V Support Proposal](https://github.com/kubernetes/kubernetes/issues/132836)
            - [K3s RISC-V Fork](https://github.com/CARV-ICS-FORTH/kubernetes-riscv64)
          files: |
            ${{ github.workspace }}/kubernetes-${{ steps.get-latest-tag.outputs.tag_name }}-riscv64-linux.tar.gz
          draft: false
          prerelease: false