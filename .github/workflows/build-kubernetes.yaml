name: Build Kubernetes for Multiple Architectures

on:
  workflow_dispatch:
  schedule:
    # Run monthly on the 1st at midnight
    - cron: "0 0 1 * *"
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  # Job to determine the Kubernetes version to build
  get-version:
    runs-on: ubuntu-latest
    outputs:
      k8s_tag: ${{ steps.get-tag.outputs.tag_name }}
    steps:
      - name: Get latest Kubernetes stable tag
        id: get-tag
        run: |
          # Fetch latest stable release tag
          LATEST_TAG=$(curl -s https://api.github.com/repos/kubernetes/kubernetes/tags | \
            jq -r '.[].name' | \
            grep -v -E 'alpha|beta|rc' | \
            grep '^v1\.' | \
            sort -V | \
            tail -n 1)
          
          echo "Latest stable Kubernetes version: $LATEST_TAG"
          echo "tag_name=$LATEST_TAG" >> "$GITHUB_OUTPUT"

  # Build for x86_64
  build-x86:
    needs: get-version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            rsync \
            jq \
            curl \
            wget

      - name: Check environment
        run: |
          set -eux
          uname -a
          gcc --version
          g++ --version
          ldd --version
          cat /etc/os-release

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'

      - name: Clone Kubernetes and checkout version
        run: |
          set -eux
          
          # Configure git for better performance
          git config --global http.postBuffer 524288000
          git config --global http.maxRequests 2
          git config --global core.compression 0
          
          # Clone Kubernetes repo
          rm -rf kubernetes
          git clone --depth=1 --no-tags https://github.com/kubernetes/kubernetes.git
          cd kubernetes
          
          # Fetch and checkout the tag
          git fetch --depth=1 origin tag ${{ needs.get-version.outputs.k8s_tag }}
          git checkout FETCH_HEAD

      - name: Setup build environment
        run: |
          cd kubernetes
          
          # Verify Go installation
          go version
          
          # Get dependencies
          go mod download

      - name: Build Kubernetes binaries for x86_64
        run: |
          cd kubernetes
          
          echo "Building Kubernetes for linux/amd64..."
          
          KUBE_BUILD_PLATFORMS=linux/amd64 make all WHAT="cmd/kube-apiserver cmd/kube-controller-manager cmd/kube-scheduler cmd/kubelet cmd/kube-proxy cmd/kubectl cmd/kubeadm"
          
          echo "Build completed!"
          ls -lh _output/local/go/bin/ || ls -lh _output/bin/ || find _output -name "kube*" -type f

      - name: Package binaries
        run: |
          cd kubernetes
          
          # Find the output directory
          if [ -d "_output/local/go/bin" ]; then
            BIN_DIR="_output/local/go/bin"
          elif [ -d "_output/bin" ]; then
            BIN_DIR="_output/bin"
          else
            echo "ERROR: Could not find binary output directory"
            find _output -name "kubectl" -type f
            exit 1
          fi
          
          echo "Using binary directory: $BIN_DIR"
          
          # Create packaging directory
          mkdir -p $GITHUB_WORKSPACE/k8s-x86_64-binaries
          
          # Copy binaries
          cp -v $BIN_DIR/kube-apiserver $GITHUB_WORKSPACE/k8s-x86_64-binaries/ || true
          cp -v $BIN_DIR/kube-controller-manager $GITHUB_WORKSPACE/k8s-x86_64-binaries/ || true
          cp -v $BIN_DIR/kube-scheduler $GITHUB_WORKSPACE/k8s-x86_64-binaries/ || true
          cp -v $BIN_DIR/kubelet $GITHUB_WORKSPACE/k8s-x86_64-binaries/ || true
          cp -v $BIN_DIR/kube-proxy $GITHUB_WORKSPACE/k8s-x86_64-binaries/ || true
          cp -v $BIN_DIR/kubectl $GITHUB_WORKSPACE/k8s-x86_64-binaries/ || true
          cp -v $BIN_DIR/kubeadm $GITHUB_WORKSPACE/k8s-x86_64-binaries/ || true
          
          # Verify binaries
          echo "Packaged binaries:"
          ls -lh $GITHUB_WORKSPACE/k8s-x86_64-binaries/
          
          # Create tarball
          tar -czf $GITHUB_WORKSPACE/kubernetes-${{ needs.get-version.outputs.k8s_tag }}-x86_64-linux.tar.gz \
            -C $GITHUB_WORKSPACE/k8s-x86_64-binaries .
          
          echo "Archive created:"
          ls -lh $GITHUB_WORKSPACE/kubernetes-${{ needs.get-version.outputs.k8s_tag }}-x86_64-linux.tar.gz

      - name: Upload x86_64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kubernetes-${{ needs.get-version.outputs.k8s_tag }}-x86_64-linux
          path: ${{ github.workspace }}/kubernetes-${{ needs.get-version.outputs.k8s_tag }}-x86_64-linux.tar.gz

  # Build for RISC-V
  build-riscv:
    needs: get-version
    runs-on: RISCV64
    permissions:
      contents: write
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            rsync \
            jq \
            curl \
            wget

      - name: Check environment
        run: |
          set -eux
          uname -a
          gcc --version
          g++ --version
          ldd --version
          cat /etc/os-release

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Go
        run: |
          # Install latest stable Go
          GO_VERSION=$(curl -s https://go.dev/VERSION?m=text | head -n1)
          wget -q https://go.dev/dl/${GO_VERSION}.linux-riscv64.tar.gz
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf ${GO_VERSION}.linux-riscv64.tar.gz
          rm ${GO_VERSION}.linux-riscv64.tar.gz
          
          # Setup Go environment
          echo "export PATH=/usr/local/go/bin:\$PATH" >> $HOME/.bashrc
          echo "export GOPATH=$HOME/go" >> $HOME/.bashrc
          echo "export PATH=\$PATH:\$GOPATH/bin" >> $HOME/.bashrc
          
          # Verify installation
          /usr/local/go/bin/go version

      - name: Clone Kubernetes and checkout version
        run: |
          set -eux
          
          # Configure git for better performance
          git config --global http.postBuffer 524288000
          git config --global http.maxRequests 2
          git config --global core.compression 0
          
          # Clone Kubernetes repo
          rm -rf kubernetes
          git clone --depth=1 --no-tags https://github.com/kubernetes/kubernetes.git
          cd kubernetes
          
          # Fetch and checkout the tag
          git fetch --depth=1 origin tag ${{ needs.get-version.outputs.k8s_tag }}
          git checkout FETCH_HEAD

      - name: Setup build environment
        run: |
          cd kubernetes
          export PATH=/usr/local/go/bin:$PATH
          export GOPATH=$HOME/go
          
          # Verify Go installation
          go version
          
          # Get dependencies
          go mod download

      - name: Build Kubernetes binaries for RISC-V
        run: |
          cd kubernetes
          export PATH=/usr/local/go/bin:$PATH
          export GOPATH=$HOME/go
          
          echo "Building Kubernetes for linux/riscv64..."
          
          KUBE_BUILD_PLATFORMS=linux/riscv64 make all WHAT="cmd/kube-apiserver cmd/kube-controller-manager cmd/kube-scheduler cmd/kubelet cmd/kube-proxy cmd/kubectl cmd/kubeadm"
          
          echo "Build completed!"
          ls -lh _output/local/go/bin/ || ls -lh _output/bin/ || find _output -name "kube*" -type f

      - name: Package binaries
        run: |
          cd kubernetes
          
          # Find the output directory
          if [ -d "_output/local/go/bin" ]; then
            BIN_DIR="_output/local/go/bin"
          elif [ -d "_output/bin" ]; then
            BIN_DIR="_output/bin"
          else
            echo "ERROR: Could not find binary output directory"
            find _output -name "kubectl" -type f
            exit 1
          fi
          
          echo "Using binary directory: $BIN_DIR"
          
          # Create packaging directory
          mkdir -p $GITHUB_WORKSPACE/k8s-riscv64-binaries
          
          # Copy binaries
          cp -v $BIN_DIR/kube-apiserver $GITHUB_WORKSPACE/k8s-riscv64-binaries/ || true
          cp -v $BIN_DIR/kube-controller-manager $GITHUB_WORKSPACE/k8s-riscv64-binaries/ || true
          cp -v $BIN_DIR/kube-scheduler $GITHUB_WORKSPACE/k8s-riscv64-binaries/ || true
          cp -v $BIN_DIR/kubelet $GITHUB_WORKSPACE/k8s-riscv64-binaries/ || true
          cp -v $BIN_DIR/kube-proxy $GITHUB_WORKSPACE/k8s-riscv64-binaries/ || true
          cp -v $BIN_DIR/kubectl $GITHUB_WORKSPACE/k8s-riscv64-binaries/ || true
          cp -v $BIN_DIR/kubeadm $GITHUB_WORKSPACE/k8s-riscv64-binaries/ || true
          
          # Verify binaries
          echo "Packaged binaries:"
          ls -lh $GITHUB_WORKSPACE/k8s-riscv64-binaries/
          
          # Create tarball
          tar -czf $GITHUB_WORKSPACE/kubernetes-${{ needs.get-version.outputs.k8s_tag }}-riscv64-linux.tar.gz \
            -C $GITHUB_WORKSPACE/k8s-riscv64-binaries .
          
          echo "Archive created:"
          ls -lh $GITHUB_WORKSPACE/kubernetes-${{ needs.get-version.outputs.k8s_tag }}-riscv64-linux.tar.gz

      - name: Upload RISC-V artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kubernetes-${{ needs.get-version.outputs.k8s_tag }}-riscv64-linux
          path: ${{ github.workspace }}/kubernetes-${{ needs.get-version.outputs.k8s_tag }}-riscv64-linux.tar.gz

  # Create release with both architectures
  create-release:
    needs: [get-version, build-x86, build-riscv]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download x86_64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: kubernetes-${{ needs.get-version.outputs.k8s_tag }}-x86_64-linux
          path: ./artifacts

      - name: Download RISC-V artifacts
        uses: actions/download-artifact@v4
        with:
          name: kubernetes-${{ needs.get-version.outputs.k8s_tag }}-riscv64-linux
          path: ./artifacts

      - name: Create or update tag
        run: |
          TAG="${{ needs.get-version.outputs.k8s_tag }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git ls-remote --exit-code --tags origin "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "âœ… Tag $TAG already exists. Will update release."
          else
            echo "ðŸ†• Tag $TAG does not exist. Creating and pushing..."
            git tag "$TAG" -m "Kubernetes $TAG build for multiple architectures"
            git push origin "$TAG"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.get-version.outputs.k8s_tag }}
          name: Kubernetes ${{ needs.get-version.outputs.k8s_tag }} for x86_64 and RISC-V
          body: |
            # Kubernetes ${{ needs.get-version.outputs.k8s_tag }} - Multi-Architecture Build
            
            **Unofficial** builds of Kubernetes ${{ needs.get-version.outputs.k8s_tag }} for x86_64 and RISC-V architectures.
            
            ## Included Binaries
            
            - `kube-apiserver` - The Kubernetes API server
            - `kube-controller-manager` - The controller manager
            - `kube-scheduler` - The scheduler
            - `kubelet` - The node agent
            - `kube-proxy` - The network proxy
            - `kubectl` - The command-line tool
            - `kubeadm` - The cluster bootstrapping tool
            
            ## Installation
            
            ### For x86_64 (AMD64)
            
            ```bash
            # Download and extract
            wget https://github.com/${{ github.repository }}/releases/download/${{ needs.get-version.outputs.k8s_tag }}/kubernetes-${{ needs.get-version.outputs.k8s_tag }}-x86_64-linux.tar.gz
            tar -xzf kubernetes-${{ needs.get-version.outputs.k8s_tag }}-x86_64-linux.tar.gz
            
            # Move binaries to PATH
            sudo mv kube* /usr/local/bin/
            
            # Verify installation
            kubectl version --client
            ```
            
            ### For RISC-V (riscv64)
            
            ```bash
            # Download and extract
            wget https://github.com/${{ github.repository }}/releases/download/${{ needs.get-version.outputs.k8s_tag }}/kubernetes-${{ needs.get-version.outputs.k8s_tag }}-riscv64-linux.tar.gz
            tar -xzf kubernetes-${{ needs.get-version.outputs.k8s_tag }}-riscv64-linux.tar.gz
            
            # Move binaries to PATH
            sudo mv kube* /usr/local/bin/
            
            # Verify installation
            kubectl version --client
            ```
            
            ## Architectures
            - **x86_64**: linux/amd64 (built on ubuntu-latest)
            - **RISC-V**: linux/riscv64 (built on Milk-V Pioneer)
            
            ## Notes
            - Built from official Kubernetes source: https://github.com/kubernetes/kubernetes
            - No modifications to source code
            - Both builds are functionally equivalent
            
            ## Related Links
            - [Official Kubernetes Docs](https://kubernetes.io/docs/)
          files: |
            ./artifacts/kubernetes-${{ needs.get-version.outputs.k8s_tag }}-x86_64-linux.tar.gz
            ./artifacts/kubernetes-${{ needs.get-version.outputs.k8s_tag }}-riscv64-linux.tar.gz
          draft: false
          prerelease: false
